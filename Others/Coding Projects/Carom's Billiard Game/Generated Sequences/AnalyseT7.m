Folder = 'T7';
Xr = [270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 270 269 268 268 268 267 267 267 267 267 267 266 255 249
];
Yr = [377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377 377
];
Xy = [213 213 213 213 213 213 213 213 213 213 213 213 213 213 213 187 145 167 199 231 261 319 348 376 401 454 479 504 530 574 598 621 644 691 714 720 701 662 647 626 610 577 561 547 533 507 494 481 468 443 430 417 405 379 367 354 341 316 304 291 278 254 241 231 218 192 179 167 154 129 130 140 153 168 175 183 192 205 211 218 225 238 245 252 259 273 279 286 293 307 313 320 327 339 348 353 361 374 379 387 392 405 413 418 426 439 444 452 457 469 476 482 488 501 507 513 519 532 538 544 550 562 569 574 582 595 598 604 610 622 628 634 640 652 660 663 669 680 686 692 697 709 715 720 725 718 714 712 708 702 699 696 693 686 683 680 677 671 668 665 662 656 653 651 648 642 639 637 634 628 626 623 620 615 612 609 608 602 599 596 595 589 586 584 582 576 574 572 569 564 562 559 557 553 550 548 546 543 539 536 535 530 530 526 524 519 517 515 513 509 507 505 504 499 497 495 493 491 488 486 484 480 478 478 475 471 470 468 466 465 461 459 458 454 453 452 452 447 445 444 442 439 439 436 435 432 431 429 428 426 424 423 421 419 417 416 415 413 413 410 409 407 405 405 404 401 400 400 400 396 395 394 393 393 393
];
Yy = [275 275 275 275 275 275 275 275 275 275 275 275 275 275 275 279 281 282 280 280 280 280 279 279 279 277 277 277 277 276 275 275 276 275 274 274 274 273 273 272 271 269 269 268 268 267 267 266 265 264 264 263 263 261 261 261 260 259 259 258 258 257 256 256 255 254 254 253 253 252 252 252 252 251 251 251 251 251 250 250 250 250 250 250 249 249 249 249 249 248 249 248 248 248 247 247 247 247 247 246 246 246 246 246 245 245 245 245 245 245 245 245 245 244 243 243 243 243 243 242 242 242 242 242 242 241 241 241 240 240 240 240 240 239 239 239 239 238 238 238 237 237 237 237 237 236 236 236 236 236 236 236 236 236 236 236 236 236 235 235 235 235 235 235 235 235 235 235 235 235 235 235 235 235 235 236 235 236 236 236 236 236 236 236 236 236 236 236 236 236 236 236 236 236 236 236 236 237 237 237 237 237 237 237 237 237 237 238 238 238 237 237 237 238 238 238 238 238 238 239 239 239 239 239 239 239 239 239 239 239 239 240 240 240 240 241 241 241 241 241 241 241 241 241 241 241 241 241 241 241 241 241 241 241 241 241 241 243 243 243 242 243 243 243 243 243 243 243 244 244 244 244 244 244 244
];
Xw = [490 490 490 490 490 490 490 490 490 490 479 431 382 288 243 226 223 215 210 205 199 186 179 172 164 150 142 135 128 146 154 162 170 184 190 196 202 213 219 224 230 241 247 253 258 269 275 280 286 297 302 308 314 324 330 336 342 355 362 369 376 389 396 403 409 423 429 436 442 456 462 469 475 488 495 501 508 521 527 533 540 553 559 565 571 584 590 597 603 615 622 628 634 646 653 658 665 677 683 689 695 707 713 719 725 721 717 713 710 704 700 697 694 688 685 681 678 671 668 665 662 655 652 649 646 639 636 633 630 624 620 617 614 608 605 602 599 593 590 587 584 579 576 573 570 564 561 559 556 550 547 545 542 537 534 531 528 523 520 518 515 510 507 504 502 497 494 492 489 484 482 479 477 472 470 467 465 460 458 455 453 448 446 444 442 437 435 433 430 426 424 421 419 415 413 411 409 405 403 401 399 395 393 391 389 385 383 381 379 375 373 371 369 366 364 362 361 357 355 353 352 348 346 345 343 340 338 337 335 332 330 329 327 324 323 322 320 317 316 314 313 310 309 308 306 303 302 300 299 296 295 294 293 291 290 289 288 287 286 285 284 282 282 281 281 280 280 279 279 278 278 278 277 277 277
];
Yw = [345 345 345 345 345 345 345 345 345 345 341 328 315 289 277 263 249 222 209 197 184 161 150 138 127 105 94 86 95 118 129 140 149 168 177 185 193 208 216 224 232 247 255 263 270 286 293 301 309 324 331 339 347 362 369 376 377 366 361 356 352 344 340 336 332 324 320 316 312 304 300 296 292 284 280 276 272 264 260 256 252 245 241 237 233 226 222 218 214 207 203 199 195 188 184 181 177 169 166 162 159 151 147 144 140 132 128 123 119 110 106 102 98 90 88 91 94 99 101 103 105 110 113 115 117 122 124 126 129 133 135 137 140 145 147 149 151 155 158 160 162 166 168 171 173 176 178 181 183 187 189 191 193 197 199 201 203 207 209 211 213 217 219 221 222 226 228 230 232 236 238 240 241 245 247 249 250 254 256 257 259 263 264 266 268 271 273 275 276 280 281 283 285 288 290 291 293 296 298 299 301 304 305 307 308 311 313 314 315 318 320 321 323 326 327 328 329 332 333 335 336 338 340 341 342 345 346 347 349 351 352 354 355 357 358 360 361 363 364 365 366 368 369 370 372 374 375 375 376 377 377 377 377 377 377 376 376 375 375 374 374 373 372 372 371 370 369 369 369 368 367 367 366 366 366
];
BorderWinColor = [0 255 22
];
BorderLossColor = [255 53 0
];
LineStyle = '-';
BorderHitStyle = 'o';

BallDiameter = 13;
MoveDistPx = 9;
BallBorderDist = 9;

% Assigning each ball its ID
Red_ID = 1; 
Yellow_ID = 2;
White_ID = 3;

% Finding the table borders using the get frame function 

[Xmin, Xmax, Ymin, Ymax] = GetFrame(Xr,Yr,Xy,Yy,Xw,Yw);

% Finding and replacing all NaN values with InterpolateNan function

[Xr, Yr] = InterpolateNan(Xr,Yr);
[Xy, Yy] = InterpolateNan(Xy,Yy);
[Xw, Yw] = InterpolateNan(Xw,Yw);

% Removing all outliers 

[Xr, Yr] = RemoveOutlier(Xr,Yr);
[Xy, Yy] = RemoveOutlier(Xy,Yy);
[Xw, Yw] = RemoveOutlier(Xw,Yw);

% Getting the total distance traveled by each ball 

PathLength_Red = GetBallPathLength(Xr,Yr);
PathLength_Yellow = GetBallPathLength(Xy,Yy);
PathLength_White = GetBallPathLength(Xw,Yw);

% Getting the ball move order 

[FirstBall, SecondBall, LastBall, NbBallsMoved] = GetBallMoveOrder(Xr,Yr,Xy,Yy,Xw,Yw,MoveDistPx);

% Assigning which ball was hit first

if (FirstBall == Red_ID)

    IdxTouch = GetTouchIdx(Xr,Yr,Xmin,Xmax,Ymin,Ymax,BallBorderDist);
    X1 = Xr;
    Y1 = Yr;
    Color = 'Red';

elseif (FirstBall == Yellow_ID)

        IdxTouch = GetTouchIdx(Xy,Yy,Xmin,Xmax,Ymin,Ymax,BallBorderDist);
        X1 = Xy;
        Y1 = Yy;
        Color = 'Yellow';

elseif (FirstBall == White_ID)

    IdxTouch = GetTouchIdx(Xw,Yw,Xmin,Xmax,Ymin,Ymax,BallBorderDist);
    X1 = Xw;
    Y1 = Yw;
    Color = 'White';

end

% Assigning which ball was hit second

if (SecondBall == Red_ID)
    X2 = Xr;
    Y2 = Yr;
    SecondTouch = GetFirstMoveIdx(Xr,Yr,MoveDistPx);
elseif (SecondBall == Yellow_ID)
    X2 = Yy;
    Y2 = Yy;
    SecondTouch = GetFirstMoveIdx(Xy,Yy,MoveDistPx);
elseif (SecondBall == White_ID)
    X2 = Xw;
    Y2 = Yw;
    SecondTouch = GetFirstMoveIdx(Xw,Yw,MoveDistPx);
end

% Assigning which ball was hit last

if (LastBall == Red_ID)
    X3 = Xr;
    Y3 = Yr;
elseif (LastBall == Yellow_ID)
    X3 = Xy;
    Y3 = Yy;
elseif (LastBall == White_ID)
    X3 = Xw;
    Y3 = Yw;
end

IdxTouch = IdxTouch(IdxTouch >= SecondTouch); % Taking border touches only after the second ball is hit
BorderHits = length(IdxTouch); % Counting border hits
NbBallsMoved = NbBallsMoved; % Number of balls moved

% Win or loss ? 

if NbBallsMoved == 3 && BorderHits >= 3
    Result = 'Win';
    BorderHitColor = BorderWinColor/255;
else
    Result = 'Loss';
    BorderHitColor = BorderLossColor/255;
end

% Creating score sheet

figure('Name','ScoreSheet','NumberTitle','off')
hold all

set(gcf,'color','white')
axis([Xmin Xmax 0 Ymax])
axis off

% Creating rectangle representing the frame

rectangle('Position',[Xmin Ymin Xmax-Xmin Ymax-Ymin],'EdgeColor','b','LineWidth',1)

% Plotting ball trajectories

plot(Xr,Yr,[LineStyle, 'r'],'LineWidth',1,'Marker','o','MarkerSize',1.5,'MarkerFaceColor','r')
plot(Xy,Yy,[LineStyle, 'y'],'LineWidth',1,'Marker','o','MarkerSize',1.5,'MarkerFaceColor','y')
plot(Xw,Yw,[LineStyle, 'b'],'LineWidth',1,'Marker','o','MarkerSize',1.5,'MarkerFaceColor','b')

% Plotting the first position of each ball

plot(Xr(1),Yr(1),'Marker','hexagram','MarkerSize',15,'MarkerEdgeColor','r')
plot(Xy(1),Yy(1),'Marker','hexagram','MarkerSize',15,'MarkerEdgeColor','y')
plot(Xw(1),Yw(1),'Marker','hexagram','MarkerSize',15,'MarkerEdgeColor','b')

% Plotting the border hits using the chosen BorderHitStyle and
% BorderHitColor from LabVIEW

scatter(X1(IdxTouch),Y1(IdxTouch),100,'Marker',BorderHitStyle,'MarkerEdgeColor',BorderHitColor)

% Displaying the captions of the score-sheet

t = char(datetime('now'));
title(['Score Sheet - ' Folder ' - (' t ')'],'FontSize',15);

text(Xmin + (Xmax - Xmin)*0.125,Ymin*0.75,{['Score sheet for ' '"' Color ' Ball' '"'],['--- ' Result ' ---']});

text(Xmin + (Xmax - Xmin)*0.125,Ymin*0.25,['dist(R):' num2str(int32(PathLength_Red)) 'px']);
text(Xmin + (Xmax - Xmin)*0.375,Ymin*0.25,['dist(Y):' num2str(int32(PathLength_Yellow)) 'px']);
text(Xmin + (Xmax - Xmin)*0.625,Ymin*0.25,['dist(W):' num2str(int32(PathLength_White)) 'px']);

text(Xmin + (Xmax - Xmin)*0.625,Ymin*0.75,{[num2str(NbBallsMoved) ' ball(s) touched'],[num2str(BorderHits) ' band(s) touched']}) 

hold off 

% Saving the score-sheet as a .pdf file under the format ScoreSheetTx.pdf

filename = sprintf('ScoreSheet%s',Folder);
saveas(gcf,filename,'pdf');

%% AnalyseTx.m 
% 
% Authors:
%   Roy Turk 34 55 77
%   Selim Sherif 34 60 35
%
% Script containing a combination of functions that will receive the ball 
% coordinates from LabVIEW and display the score-sheet with the final 
% result of the game.