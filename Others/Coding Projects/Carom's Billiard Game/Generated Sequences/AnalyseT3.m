Folder = 'T3';
Xr = [655 655 655 655 655 651 643 627 620 608 596 591 579 575 565 562 552 547 538 529 524 515 511 501 497 488 478 474 465 460 452 448 439 435 426 417 413 404 400 392 388 379 371 367 359 355 347 343 335 331 323 315 311 304 300 292 288 281 273 269 262 258 251 247 240 236 229 223 219 211 208 201 198 191 184 181 174 171 163 161 154 151 145 137 135 129 129 131 133 138 141 143 146 148 151 153 156 157 161 164 166 168 170 173 175 178 181 182 185 186 189 190 193 195 197 200 201 204 205 206 208 210 212 214 215 217 218 219 221 223 225 227 228 229 230 232 233 235 236 237 239 240 241 242 243 244 245 247 247 247 248 249 249 251 253 253 255 254 255 255 256 257 258 259 259 259 259 260 260 260 261 261 261 261 261 261 261 261 261 262 262 262
];
Yr = [334 334 334 334 334 335 341 353 357 365 373 377 377 374 370 367 363 361 357 353 351 347 345 341 339 334 331 329 324 323 319 317 313 311 307 303 301 297 295 291 291 287 283 281 277 275 271 269 265 263 260 257 254 251 249 245 244 241 237 235 232 230 227 225 221 221 217 214 213 209 208 205 203 199 196 194 191 189 187 185 182 181 178 175 173 169 169 167 165 163 160 159 157 157 155 153 151 151 149 147 145 143 143 141 139 138 137 135 133 133 131 129 127 127 125 124 123 121 121 119 119 117 116 115 113 113 111 111 109 109 108 107 105 105 104 103 103 101 101 100 99 99 97 97 97 96 95 94 94 93 93 93 93 91 91 91 89 89 89 89 88 88 87 86 86 86 87 86 86 87 87 88 88 87 87 87 87 87 87 87 87 87
];
Xy = [726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 728 726 726 726 728 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 726 725 725 723 722 721 721 719 719 718 717 717 716 715 715 714 714 713 713 712 712 712 712 712 712 712 708 712 708
];
Yy = [135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 135 134 137 138 139 140 141 142 143 143 144 145 146 147 147 148 149 149 151 151 151 152 152 153 154 154 154 155 155 155
];
Xw = [638 638 645 654 658 669 681 704 719 711 688 677 657 647 629 620 604 595 579 562 554 538 529 513 505 487 469 461 443 434 417 408 390 382 364 347 338 321 312 295 287 270 253 244 227 219 202 194 177 169 152 136 128 138 144 154 159 168 177 181 191 195 205 210 219 224 233 242 247 256 261 270 275 283 293 297 306 311 319 324 333 337 346 354 359 367 371 380 384 393 401 405 414 418 426 430 439 442 450 458 462 470 474 482 486 494 501 505 513 517 524 528 536 539 547 554 558 565 569 576 579 586 593 597 604 608 614 618 624 628 634 639 642 647 650 655 657 662 667 670 675 677 682 684 689 692 696 701 703 708 710 714 717 720 722 723 725 726 727 726 725 725 724 723 722 722 721 721 720 719 719 718 718 717 717 717 716 716 716 716 716 715
];
Yw = [162 162 210 260 285 331 348 380 367 338 310 297 272 261 239 228 209 198 179 159 149 129 119 99 89 98 112 117 128 134 144 149 160 165 175 185 191 201 206 216 221 231 241 246 256 261 271 276 286 291 301 311 315 327 333 344 350 361 372 378 372 369 363 360 354 351 345 339 336 330 327 321 318 312 306 303 298 295 289 286 280 278 272 266 263 258 255 250 247 242 236 234 229 226 220 218 212 210 205 199 197 192 189 184 181 177 172 169 164 162 157 154 150 147 142 138 135 131 128 124 121 117 112 110 105 103 99 97 92 90 88 90 91 94 95 97 98 100 102 103 105 106 108 109 111 112 114 116 117 119 120 122 123 123 123 122 122 122 121 121 121 120 120 119 119 119 119 118 118 118 117 117 117 117 117 117 116 116 116 116 116 116
];
BorderWinColor = [0 255 22
];
BorderLossColor = [255 53 0
];
LineStyle = '-';
BorderHitStyle = 'o';

BallDiameter = 13;
MoveDistPx = 9;
BallBorderDist = 9;

% Assigning each ball its ID
Red_ID = 1; 
Yellow_ID = 2;
White_ID = 3;

% Finding the table borders using the get frame function 

[Xmin, Xmax, Ymin, Ymax] = GetFrame(Xr,Yr,Xy,Yy,Xw,Yw);

% Finding and replacing all NaN values with InterpolateNan function

[Xr, Yr] = InterpolateNan(Xr,Yr);
[Xy, Yy] = InterpolateNan(Xy,Yy);
[Xw, Yw] = InterpolateNan(Xw,Yw);

% Removing all outliers 

[Xr, Yr] = RemoveOutlier(Xr,Yr);
[Xy, Yy] = RemoveOutlier(Xy,Yy);
[Xw, Yw] = RemoveOutlier(Xw,Yw);

% Getting the total distance traveled by each ball 

PathLength_Red = GetBallPathLength(Xr,Yr);
PathLength_Yellow = GetBallPathLength(Xy,Yy);
PathLength_White = GetBallPathLength(Xw,Yw);

% Getting the ball move order 

[FirstBall, SecondBall, LastBall, NbBallsMoved] = GetBallMoveOrder(Xr,Yr,Xy,Yy,Xw,Yw,MoveDistPx);

% Assigning which ball was hit first

if (FirstBall == Red_ID)

    IdxTouch = GetTouchIdx(Xr,Yr,Xmin,Xmax,Ymin,Ymax,BallBorderDist);
    X1 = Xr;
    Y1 = Yr;
    Color = 'Red';

elseif (FirstBall == Yellow_ID)

        IdxTouch = GetTouchIdx(Xy,Yy,Xmin,Xmax,Ymin,Ymax,BallBorderDist);
        X1 = Xy;
        Y1 = Yy;
        Color = 'Yellow';

elseif (FirstBall == White_ID)

    IdxTouch = GetTouchIdx(Xw,Yw,Xmin,Xmax,Ymin,Ymax,BallBorderDist);
    X1 = Xw;
    Y1 = Yw;
    Color = 'White';

end

% Assigning which ball was hit second

if (SecondBall == Red_ID)
    X2 = Xr;
    Y2 = Yr;
    SecondTouch = GetFirstMoveIdx(Xr,Yr,MoveDistPx);
elseif (SecondBall == Yellow_ID)
    X2 = Yy;
    Y2 = Yy;
    SecondTouch = GetFirstMoveIdx(Xy,Yy,MoveDistPx);
elseif (SecondBall == White_ID)
    X2 = Xw;
    Y2 = Yw;
    SecondTouch = GetFirstMoveIdx(Xw,Yw,MoveDistPx);
end

% Assigning which ball was hit last

if (LastBall == Red_ID)
    X3 = Xr;
    Y3 = Yr;
elseif (LastBall == Yellow_ID)
    X3 = Xy;
    Y3 = Yy;
elseif (LastBall == White_ID)
    X3 = Xw;
    Y3 = Yw;
end

IdxTouch = IdxTouch(IdxTouch >= SecondTouch); % Taking border touches only after the second ball is hit
BorderHits = length(IdxTouch); % Counting border hits
NbBallsMoved = NbBallsMoved; % Number of balls moved

% Win or loss ? 

if NbBallsMoved == 3 && BorderHits >= 3
    Result = 'Win';
    BorderHitColor = BorderWinColor/255;
else
    Result = 'Loss';
    BorderHitColor = BorderLossColor/255;
end

% Creating score sheet

figure('Name','ScoreSheet','NumberTitle','off')
hold all

set(gcf,'color','white')
axis([Xmin Xmax 0 Ymax])
axis off

% Creating rectangle representing the frame

rectangle('Position',[Xmin Ymin Xmax-Xmin Ymax-Ymin],'EdgeColor','b','LineWidth',1)

% Plotting ball trajectories

plot(Xr,Yr,[LineStyle, 'r'],'LineWidth',1,'Marker','o','MarkerSize',1.5,'MarkerFaceColor','r')
plot(Xy,Yy,[LineStyle, 'y'],'LineWidth',1,'Marker','o','MarkerSize',1.5,'MarkerFaceColor','y')
plot(Xw,Yw,[LineStyle, 'b'],'LineWidth',1,'Marker','o','MarkerSize',1.5,'MarkerFaceColor','b')

% Plotting the first position of each ball

plot(Xr(1),Yr(1),'Marker','hexagram','MarkerSize',15,'MarkerEdgeColor','r')
plot(Xy(1),Yy(1),'Marker','hexagram','MarkerSize',15,'MarkerEdgeColor','y')
plot(Xw(1),Yw(1),'Marker','hexagram','MarkerSize',15,'MarkerEdgeColor','b')

% Plotting the border hits using the chosen BorderHitStyle and
% BorderHitColor from LabVIEW

scatter(X1(IdxTouch),Y1(IdxTouch),100,'Marker',BorderHitStyle,'MarkerEdgeColor',BorderHitColor)

% Displaying the captions of the score-sheet

t = char(datetime('now'));
title(['Score Sheet - ' Folder ' - (' t ')'],'FontSize',15);

text(Xmin + (Xmax - Xmin)*0.125,Ymin*0.75,{['Score sheet for ' '"' Color ' Ball' '"'],['--- ' Result ' ---']});

text(Xmin + (Xmax - Xmin)*0.125,Ymin*0.25,['dist(R):' num2str(int32(PathLength_Red)) 'px']);
text(Xmin + (Xmax - Xmin)*0.375,Ymin*0.25,['dist(Y):' num2str(int32(PathLength_Yellow)) 'px']);
text(Xmin + (Xmax - Xmin)*0.625,Ymin*0.25,['dist(W):' num2str(int32(PathLength_White)) 'px']);

text(Xmin + (Xmax - Xmin)*0.625,Ymin*0.75,{[num2str(NbBallsMoved) ' ball(s) touched'],[num2str(BorderHits) ' band(s) touched']}) 

hold off 

% Saving the score-sheet as a .pdf file under the format ScoreSheetTx.pdf

filename = sprintf('ScoreSheet%s',Folder);
saveas(gcf,filename,'pdf');

%% AnalyseTx.m 
% 
% Authors:
%   Roy Turk 34 55 77
%   Selim Sherif 34 60 35
%
% Script containing a combination of functions that will receive the ball 
% coordinates from LabVIEW and display the score-sheet with the final 
% result of the game.