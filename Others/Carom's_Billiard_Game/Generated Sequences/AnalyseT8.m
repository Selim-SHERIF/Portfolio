Folder = 'T8';
Xr = [267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 267 266 265 265 264 262 262 261 261 259 258 258 257
];
Yr = [378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378 378
];
Xy = [580 580 547 499 453 407 340 330 322 312 296 287 277 270 254 246 238 231 215 205 194 183 160 149 140 127 140 147 155 162 175 181 186 192 202 207 212 218 227 232 237 244 252 257 262 270 277 282 287 294 309 316 323 330 343 350 357 364 378 387 391 400 413 418 426 432 445 452 459 465 479 485 492 499 512 518 525 531 544 551 557 563 576 583 589 596 608 614 621 627 640 647 652 660 673 677 686 689 701 707 714 719 725 719 715 712 705 701 699 699 687 686 680 676 669 665 661 660 651 647 643 640 634 629 628 623 616 612 609 605 598 595 591 588 582 578 575 571 565 562 558 556 549 545 543 539 533 530 526 523 517 514 511 508 502 499 496 493 487 484 481 478 472 469 466 465 457 454 452 449 443 440 439 435 429 426 426 421 415 413 410 407 402 400 397 394 389 387 384 381 376 374 371 369 364 361 361 357 352 349 348 345 340 338 335 335 329 326 324 322 317 315 313 311 309 305 302 300 296 294 293 290 286 284 282 281 279 278 278 277 276 276 276 275 274 274 273 273
];
Yy = [309 309 311 309 308 307 289 273 257 242 214 201 188 176 153 141 130 118 95 89 98 107 123 131 137 143 160 169 178 187 204 212 220 228 244 252 260 269 285 293 301 309 325 332 341 349 364 372 378 377 365 359 354 350 342 338 335 331 323 319 315 311 304 300 296 292 284 281 277 273 265 261 257 254 246 243 239 235 228 224 220 217 209 206 202 199 191 188 184 180 174 170 166 163 156 153 149 145 138 135 132 128 120 115 110 105 96 91 89 93 99 101 104 106 111 114 116 119 124 126 129 131 136 139 141 144 149 151 154 156 161 163 166 168 173 175 177 180 184 187 189 192 196 198 201 203 207 210 212 214 218 220 223 225 229 231 233 235 240 242 244 246 250 252 254 257 261 262 264 267 271 273 274 277 280 282 284 286 290 292 294 296 300 301 303 305 309 310 312 314 317 319 321 323 326 328 329 331 334 336 338 340 343 344 346 348 351 352 354 355 358 360 362 363 366 367 369 371 373 375 376 377 378 378 378 378 376 376 375 374 372 371 371 369 368 367 366 365
];
Xw = [337 337 337 337 337 337 310 275 241 208 146 128 149 170 211 230 249 267 302 318 334 350 381 396 412 427 458 473 488 503 534 549 564 579 608 621 635 648 674 687 700 714 719 708 698 688 670 662 655 648 634 627 620 613 599 592 585 578 564 557 551 544 530 523 517 510 496 490 483 476 462 456 449 443 429 423 416 410 397 391 384 378 365 358 352 346 333 327 321 314 302 296 289 283 271 265 258 253 240 234 228 222 210 204 198 192 180 174 168 162 151 145 139 134 131 135 139 142 149 153 156 159 166 170 173 176 183 186 190 193 200 203 206 210 216 219 222 226 232 235 238 241 247 250 253 256 262 265 267 270 276 279 282 285 290 293 296 299 304 307 310 313 318 320 323 326 331 334 336 339 344 347 349 352 357 359 362 365 369 372 374 377 381 384 386 388 393 395 398 400 405 407 409 411 416 418 420 422 426 429 431 433 437 439 441 443 447 449 452 453 457 459 461 463 467 469 471 472 476 478 480 482 485 487 489 491 494 496 497 499 503 504 506 507 511 512 514 517
];
Yw = [307 307 307 307 307 307 318 334 349 363 370 357 345 333 309 298 288 277 256 247 237 228 211 202 193 184 166 157 148 139 122 113 104 95 93 100 106 112 122 127 132 137 148 155 162 169 183 190 197 203 217 223 230 237 250 256 263 269 283 289 295 302 315 322 328 334 347 354 360 366 378 376 371 367 360 356 353 349 341 338 335 331 323 320 317 313 306 303 299 296 289 285 282 278 271 268 265 261 254 251 247 244 237 234 231 228 221 218 214 211 205 201 198 195 188 184 180 177 169 165 162 158 151 147 144 140 133 130 126 123 116 112 109 105 98 95 91 88 89 91 93 95 99 101 103 105 108 110 112 114 118 119 121 123 127 129 130 132 136 137 139 141 145 146 148 150 153 155 156 158 161 163 165 166 170 171 173 174 178 179 181 182 186 187 189 190 193 195 196 198 201 202 204 205 208 210 211 213 215 217 218 220 223 224 225 227 229 231 232 233 236 238 239 240 243 244 245 246 249 250 251 253 255 256 257 258 261 262 263 265 267 268 269 270 272 273 274 275
];
BorderWinColor = [0 255 22
];
BorderLossColor = [255 53 0
];
LineStyle = '-';
BorderHitStyle = 'o';

BallDiameter = 13;
MoveDistPx = 9;
BallBorderDist = 9;

% Assigning each ball its ID
Red_ID = 1; 
Yellow_ID = 2;
White_ID = 3;

% Finding the table borders using the get frame function 

[Xmin, Xmax, Ymin, Ymax] = GetFrame(Xr,Yr,Xy,Yy,Xw,Yw);

% Finding and replacing all NaN values with InterpolateNan function

[Xr, Yr] = InterpolateNan(Xr,Yr);
[Xy, Yy] = InterpolateNan(Xy,Yy);
[Xw, Yw] = InterpolateNan(Xw,Yw);

% Removing all outliers 

[Xr, Yr] = RemoveOutlier(Xr,Yr);
[Xy, Yy] = RemoveOutlier(Xy,Yy);
[Xw, Yw] = RemoveOutlier(Xw,Yw);

% Getting the total distance traveled by each ball 

PathLength_Red = GetBallPathLength(Xr,Yr);
PathLength_Yellow = GetBallPathLength(Xy,Yy);
PathLength_White = GetBallPathLength(Xw,Yw);

% Getting the ball move order 

[FirstBall, SecondBall, LastBall, NbBallsMoved] = GetBallMoveOrder(Xr,Yr,Xy,Yy,Xw,Yw,MoveDistPx);

% Assigning which ball was hit first

if (FirstBall == Red_ID)

    IdxTouch = GetTouchIdx(Xr,Yr,Xmin,Xmax,Ymin,Ymax,BallBorderDist);
    X1 = Xr;
    Y1 = Yr;
    Color = 'Red';

elseif (FirstBall == Yellow_ID)

        IdxTouch = GetTouchIdx(Xy,Yy,Xmin,Xmax,Ymin,Ymax,BallBorderDist);
        X1 = Xy;
        Y1 = Yy;
        Color = 'Yellow';

elseif (FirstBall == White_ID)

    IdxTouch = GetTouchIdx(Xw,Yw,Xmin,Xmax,Ymin,Ymax,BallBorderDist);
    X1 = Xw;
    Y1 = Yw;
    Color = 'White';

end

% Assigning which ball was hit second

if (SecondBall == Red_ID)
    X2 = Xr;
    Y2 = Yr;
    SecondTouch = GetFirstMoveIdx(Xr,Yr,MoveDistPx);
elseif (SecondBall == Yellow_ID)
    X2 = Yy;
    Y2 = Yy;
    SecondTouch = GetFirstMoveIdx(Xy,Yy,MoveDistPx);
elseif (SecondBall == White_ID)
    X2 = Xw;
    Y2 = Yw;
    SecondTouch = GetFirstMoveIdx(Xw,Yw,MoveDistPx);
end

% Assigning which ball was hit last

if (LastBall == Red_ID)
    X3 = Xr;
    Y3 = Yr;
elseif (LastBall == Yellow_ID)
    X3 = Xy;
    Y3 = Yy;
elseif (LastBall == White_ID)
    X3 = Xw;
    Y3 = Yw;
end

IdxTouch = IdxTouch(IdxTouch >= SecondTouch); % Taking border touches only after the second ball is hit
BorderHits = length(IdxTouch); % Counting border hits
NbBallsMoved = NbBallsMoved; % Number of balls moved

% Win or loss ? 

if NbBallsMoved == 3 && BorderHits >= 3
    Result = 'Win';
    BorderHitColor = BorderWinColor/255;
else
    Result = 'Loss';
    BorderHitColor = BorderLossColor/255;
end

% Creating score sheet

figure('Name','ScoreSheet','NumberTitle','off')
hold all

set(gcf,'color','white')
axis([Xmin Xmax 0 Ymax])
axis off

% Creating rectangle representing the frame

rectangle('Position',[Xmin Ymin Xmax-Xmin Ymax-Ymin],'EdgeColor','b','LineWidth',1)

% Plotting ball trajectories

plot(Xr,Yr,[LineStyle, 'r'],'LineWidth',1,'Marker','o','MarkerSize',1.5,'MarkerFaceColor','r')
plot(Xy,Yy,[LineStyle, 'y'],'LineWidth',1,'Marker','o','MarkerSize',1.5,'MarkerFaceColor','y')
plot(Xw,Yw,[LineStyle, 'b'],'LineWidth',1,'Marker','o','MarkerSize',1.5,'MarkerFaceColor','b')

% Plotting the first position of each ball

plot(Xr(1),Yr(1),'Marker','hexagram','MarkerSize',15,'MarkerEdgeColor','r')
plot(Xy(1),Yy(1),'Marker','hexagram','MarkerSize',15,'MarkerEdgeColor','y')
plot(Xw(1),Yw(1),'Marker','hexagram','MarkerSize',15,'MarkerEdgeColor','b')

% Plotting the border hits using the chosen BorderHitStyle and
% BorderHitColor from LabVIEW

scatter(X1(IdxTouch),Y1(IdxTouch),100,'Marker',BorderHitStyle,'MarkerEdgeColor',BorderHitColor)

% Displaying the captions of the score-sheet

t = char(datetime('now'));
title(['Score Sheet - ' Folder ' - (' t ')'],'FontSize',15);

text(Xmin + (Xmax - Xmin)*0.125,Ymin*0.75,{['Score sheet for ' '"' Color ' Ball' '"'],['--- ' Result ' ---']});

text(Xmin + (Xmax - Xmin)*0.125,Ymin*0.25,['dist(R):' num2str(int32(PathLength_Red)) 'px']);
text(Xmin + (Xmax - Xmin)*0.375,Ymin*0.25,['dist(Y):' num2str(int32(PathLength_Yellow)) 'px']);
text(Xmin + (Xmax - Xmin)*0.625,Ymin*0.25,['dist(W):' num2str(int32(PathLength_White)) 'px']);

text(Xmin + (Xmax - Xmin)*0.625,Ymin*0.75,{[num2str(NbBallsMoved) ' ball(s) touched'],[num2str(BorderHits) ' band(s) touched']}) 

hold off 

% Saving the score-sheet as a .pdf file under the format ScoreSheetTx.pdf

filename = sprintf('ScoreSheet%s',Folder);
saveas(gcf,filename,'pdf');

%% AnalyseTx.m 
% 
% Authors:
%   Roy Turk 34 55 77
%   Selim Sherif 34 60 35
%
% Script containing a combination of functions that will receive the ball 
% coordinates from LabVIEW and display the score-sheet with the final 
% result of the game.